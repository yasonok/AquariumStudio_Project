<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å•†å“ç®¡ç† - Aquarium Studio</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif; background: #f0f2f5; min-height: 100vh; }
        
        /* é ‚éƒ¨å°èˆª */
        .top-nav { background: linear-gradient(135deg, #667eea, #764ba2); color: white; padding: 15px 20px; display: flex; justify-content: space-between; align-items: center; position: sticky; top: 0; z-index: 100; }
        .top-nav h1 { font-size: 1.2rem; }
        .top-nav button { background: rgba(255,255,255,0.2); border: none; color: white; padding: 8px 15px; border-radius: 8px; cursor: pointer; font-size: 0.9rem; }
        
        /* çµ±è¨ˆå¡ç‰‡ */
        .stats-row { display: flex; gap: 10px; padding: 15px; background: white; margin-bottom: 10px; }
        .stat-box { flex: 1; text-align: center; padding: 15px; background: #f8f9fa; border-radius: 12px; }
        .stat-box .num { font-size: 1.5rem; font-weight: bold; color: #667eea; }
        .stat-box .label { font-size: 0.8rem; color: #666; margin-top: 5px; }
        
        /* å•†å“åˆ—è¡¨ */
        .product-section { padding: 15px; }
        .section-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; }
        .section-header h2 { font-size: 1.1rem; color: #333; }
        .add-btn { background: #667eea; color: white; border: none; padding: 10px 20px; border-radius: 10px; font-size: 1rem; cursor: pointer; }
        
        .product-card { background: white; border-radius: 12px; padding: 15px; margin-bottom: 10px; display: flex; gap: 15px; box-shadow: 0 2px 8px rgba(0,0,0,0.08); }
        .product-card img { width: 80px; height: 80px; object-fit: cover; border-radius: 8px; background: #eee; }
        .product-card .info { flex: 1; }
        .product-card .name { font-weight: 600; font-size: 1rem; margin-bottom: 5px; }
        .product-card .meta { font-size: 0.85rem; color: #666; margin-bottom: 8px; }
        .product-card .price { font-size: 1.1rem; font-weight: bold; color: #667eea; }
        .product-card .actions { display: flex; flex-direction: column; gap: 5px; }
        .product-card .actions button { padding: 8px 12px; border: none; border-radius: 8px; cursor: pointer; font-size: 0.85rem; }
        .btn-edit { background: #667eea; color: white; }
        .btn-delete { background: #ff6b6b; color: white; }
        
        /* æµ®å‹•æŒ‰éˆ• */
        .fab { position: fixed; bottom: 20px; right: 20px; width: 60px; height: 60px; border-radius: 50%; background: linear-gradient(135deg, #667eea, #764ba2); color: white; border: none; font-size: 2rem; cursor: pointer; box-shadow: 0 4px 20px rgba(102, 126, 234, 0.4); display: flex; align-items: center; justify-content: center; }
        
        /* æ¨¡æ…‹æ¡† */
        .modal { display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.5); z-index: 200; align-items: center; justify-content: center; padding: 20px; }
        .modal.active { display: flex; }
        .modal-content { background: white; border-radius: 16px; width: 100%; max-width: 400px; max-height: 90vh; overflow-y: auto; }
        .modal-header { padding: 15px 20px; border-bottom: 1px solid #eee; display: flex; justify-content: space-between; align-items: center; }
        .modal-header h3 { font-size: 1.1rem; }
        .modal-close { background: none; border: none; font-size: 1.5rem; cursor: pointer; color: #666; }
        .modal-body { padding: 20px; }
        
        /* è¡¨å–® */
        .form-group { margin-bottom: 15px; }
        .form-group label { display: block; font-weight: 500; margin-bottom: 8px; font-size: 0.9rem; }
        .form-group input, .form-group select, .form-group textarea { width: 100%; padding: 12px; border: 2px solid #eee; border-radius: 10px; font-size: 1rem; }
        .form-group input:focus { outline: none; border-color: #667eea; }
        
        /* åœ–ç‰‡ä¸Šå‚³ */
        .upload-box { border: 2px dashed #ddd; border-radius: 12px; padding: 30px; text-align: center; cursor: pointer; background: #f8f9fa; }
        .upload-box:hover { border-color: #667eea; background: #f0f4ff; }
        .upload-box .icon { font-size: 2.5rem; margin-bottom: 10px; }
        .upload-box p { color: #666; font-size: 0.9rem; }
        .upload-preview { width: 100%; border-radius: 10px; margin-top: 10px; display: none; }
        .upload-preview.show { display: block; }
        
        /* è£å‰ªå€åŸŸ */
        .crop-area { position: relative; margin-top: 15px; display: none; }
        .crop-area.show { display: block; }
        .crop-area img { width: 100%; border-radius: 10px; display: block; }
        .crop-overlay { position: absolute; top: 10%; left: 5%; right: 5%; bottom: 10%; border: 2px solid #667eea; background: rgba(102, 126, 234, 0.2); border-radius: 8px; }
        .crop-hint { text-align: center; color: #666; font-size: 0.85rem; margin-top: 10px; }
        
        /* æŒ‰éˆ•çµ„ */
        .btn-row { display: flex; gap: 10px; margin-top: 20px; }
        .btn-row button { flex: 1; padding: 14px; border: none; border-radius: 10px; font-size: 1rem; font-weight: 600; cursor: pointer; }
        .btn-primary { background: linear-gradient(135deg, #667eea, #764ba2); color: white; }
        .btn-secondary { background: #eee; color: #666; }
        
        /* ç©ºç‹€æ…‹ */
        .empty-state { text-align: center; padding: 50px 20px; color: #999; }
        .empty-state .icon { font-size: 3rem; margin-bottom: 15px; }
        
        /* é è¦½å¤§åœ– */
        .preview-full { width: 100%; border-radius: 12px; margin-bottom: 15px; display: none; }
        .preview-full.show { display: block; }
    </style>
</head>
<body>
    <!-- é ‚éƒ¨å°èˆª -->
    <div class="top-nav">
        <h1>ğŸ›ï¸ å•†å“ç®¡ç†</h1>
        <button onclick="clearAllData()">ğŸ—‘ï¸ æ¸…é™¤å…¨éƒ¨</button>
    </div>
    
    <!-- çµ±è¨ˆ -->
    <div class="stats-row">
        <div class="stat-box">
            <div class="num" id="stat-products">0</div>
            <div class="label">å•†å“æ•¸</div>
        </div>
        <div class="stat-box">
            <div class="num" id="stat-stock">0</div>
            <div class="label">ç¸½åº«å­˜</div>
        </div>
    </div>
    
    <!-- å•†å“åˆ—è¡¨ -->
    <div class="product-section">
        <div class="section-header">
            <h2>ğŸ“¦ å•†å“åˆ—è¡¨</h2>
        </div>
        <div id="product-list">
            <div class="empty-state">
                <div class="icon">ğŸ“¦</div>
                <p>å°šæœªæœ‰å•†å“</p>
                <p style="font-size: 0.85rem; margin-top: 10px;">é»æ“Šä¸‹æ–¹ + æŒ‰éˆ•æ–°å¢</p>
            </div>
        </div>
    </div>
    
    <!-- æµ®å‹•æŒ‰éˆ• -->
    <button class="fab" onclick="openAddModal()">+</button>
    
    <!-- æ–°å¢/ç·¨è¼¯ Modal -->
    <div class="modal" id="productModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 id="modalTitle">æ–°å¢å•†å“</h3>
                <button class="modal-close" onclick="closeModal()">&times;</button>
            </div>
            <div class="modal-body">
                <!-- åœ–ç‰‡é è¦½ -->
                <img id="previewImage" class="preview-full" alt="é è¦½">
                
                <!-- è£å‰ªå€åŸŸ -->
                <div class="crop-area" id="cropArea">
                    <img id="cropImage" src="" alt="è£å‰ª">
                    <div class="crop-overlay" id="cropOverlay"></div>
                    <p class="crop-hint">ğŸ‘† æ‹–å‹•æ–¹æ¡†é¸æ“‡ç¯„åœ</p>
                </div>
                
                <!-- ä¸Šå‚³å€åŸŸ -->
                <div class="upload-box" id="uploadBox" onclick="document.getElementById('imageInput').click()">
                    <div class="icon">ğŸ“·</div>
                    <p>é»æ“Šé¸æ“‡åœ–ç‰‡</p>
                </div>
                <input type="file" id="imageInput" accept="image/*" style="display: none;" onchange="handleImage(this)">
                
                <form onsubmit="saveProduct(event)">
                    <input type="hidden" id="productId">
                    <input type="hidden" id="finalImage">
                    
                    <div class="form-group">
                        <label>ğŸŸ åç¨± *</label>
                        <input type="text" id="productName" required placeholder="ä¾‹å¦‚ï¼šç´…è‰²å­”é›€é­š">
                    </div>
                    
                    <div class="form-group">
                        <label>ğŸ’° åƒ¹æ ¼ *</label>
                        <input type="number" id="productPrice" required placeholder="200" min="0">
                    </div>
                    
                    <div class="form-group">
                        <label>ğŸ“¦ åº«å­˜ *</label>
                        <input type="number" id="productStock" required placeholder="10" min="0">
                    </div>
                    
                    <div class="form-group">
                        <label>ğŸ·ï¸ åˆ†é¡ *</label>
                        <select id="productCategory" required>
                            <option value="å­”é›€é­š">ğŸŸ å­”é›€é­š</option>
                            <option value="è¨­å‚™">âš™ï¸ è¨­å‚™</option>
                            <option value="é£¼æ–™">ğŸ¦ é£¼æ–™</option>
                            <option value="æ°´è³ª">ğŸ’§ æ°´è³ª</option>
                            <option value="å…¶ä»–">ğŸ“ å…¶ä»–</option>
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label>ğŸ“ æè¿°</label>
                        <textarea id="productDesc" rows="2" placeholder="å•†å“ç‰¹è‰²èªªæ˜"></textarea>
                    </div>
                    
                    <div class="btn-row">
                        <button type="button" class="btn-secondary" onclick="skipCrop()">è·³éè£å‰ª</button>
                        <button type="submit" class="btn-primary">ğŸ’¾ å„²å­˜</button>
                    </div>
                </form>
            </div>
        </div>
    </div>
    
    <script>
        const STORAGE_KEY = 'aquarium_products';
        let cropState = { x: 0.1, y: 0.1, w: 0.8, h: 0.8 };
        
        // è¼‰å…¥å•†å“
        function loadProducts() {
            return JSON.parse(localStorage.getItem(STORAGE_KEY) || '[]');
        }
        
        // å„²å­˜å•†å“
        function saveProducts(products) {
            localStorage.setItem(STORAGE_KEY, JSON.stringify(products));
        }
        
        // æ¸²æŸ“åˆ—è¡¨
        function renderProducts() {
            const products = loadProducts();
            const list = document.getElementById('product-list');
            const statProducts = document.getElementById('stat-products');
            const statStock = document.getElementById('stat-stock');
            
            statProducts.textContent = products.length;
            statStock.textContent = products.reduce((sum, p) => sum + (p.stock || 0), 0);
            
            if (products.length === 0) {
                list.innerHTML = '<div class="empty-state"><div class="icon">ğŸ“¦</div><p>å°šæœªæœ‰å•†å“</p><p style="font-size: 0.85rem; margin-top: 10px;">é»æ“Šä¸‹æ–¹ + æŒ‰éˆ•æ–°å¢</p></div>';
                return;
            }
            
            list.innerHTML = products.map(p => `
                <div class="product-card">
                    <img src="${p.image || 'data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><rect fill=%22%23eee%22 width=%22100%22 height=%22100%22/><text x=%2250%22 y=%2255%22 text-anchor=%22middle%22>ğŸŸ</text></svg>'}" 
                         alt="${p.name}" onerror="this.src='data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><rect fill=%22%23eee%22 width=%22100%22 height=%22100%22/><text x=%2250%22 y=%2255%22 text-anchor=%22middle%22>ğŸŸ</text></svg>'">
                    <div class="info">
                        <div class="name">${p.name}</div>
                        <div class="meta">${p.category} â€¢ åº«å­˜: ${p.stock}</div>
                        <div class="price">$${p.price}</div>
                    </div>
                    <div class="actions">
                        <button class="btn-edit" onclick="editProduct(${p.id})">âœï¸ ç·¨è¼¯</button>
                        <button class="btn-delete" onclick="deleteProduct(${p.id})">ğŸ—‘ï¸ åˆªé™¤</button>
                    </div>
                </div>
            `).join('');
        }
        
        // æ‰“é–‹æ–°å¢Modal
        function openAddModal() {
            document.getElementById('modalTitle').textContent = 'æ–°å¢å•†å“';
            document.getElementById('productId').value = '';
            document.getElementById('productForm')?.reset();
            document.getElementById('previewImage').classList.remove('show');
            document.getElementById('cropArea').classList.remove('show');
            document.getElementById('uploadBox').style.display = 'block';
            document.getElementById('finalImage').value = '';
            document.getElementById('productModal').classList.add('active');
        }
        
        // ç·¨è¼¯å•†å“
        function editProduct(id) {
            const products = loadProducts();
            const p = products.find(x => x.id === id);
            if (!p) return;
            
            document.getElementById('modalTitle').textContent = 'ç·¨è¼¯å•†å“';
            document.getElementById('productId').value = p.id;
            document.getElementById('productName').value = p.name;
            document.getElementById('productPrice').value = p.price;
            document.getElementById('productStock').value = p.stock;
            document.getElementById('productCategory').value = p.category;
            document.getElementById('productDesc').value = p.description || '';
            document.getElementById('finalImage').value = p.image || '';
            
            if (p.image) {
                document.getElementById('previewImage').src = p.image;
                document.getElementById('previewImage').classList.add('show');
                document.getElementById('uploadBox').style.display = 'none';
                document.getElementById('cropArea').classList.remove('show');
            } else {
                document.getElementById('previewImage').classList.remove('show');
                document.getElementById('uploadBox').style.display = 'block';
            }
            
            document.getElementById('productModal').classList.add('active');
        }
        
        // åˆªé™¤å•†å“
        function deleteProduct(id) {
            if (!confirm('ç¢ºå®šè¦åˆªé™¤é€™å€‹å•†å“å—ï¼Ÿ')) return;
            let products = loadProducts();
            products = products.filter(p => p.id !== id);
            saveProducts(products);
            renderProducts();
        }
        
        // é—œé–‰Modal
        function closeModal() {
            document.getElementById('productModal').classList.remove('active');
        }
        
        // è™•ç†åœ–ç‰‡
        function handleImage(input) {
            if (!input.files[0]) return;
            const reader = new FileReader();
            reader.onload = function(e) {
                showCropDialog(e.target.result);
            };
            reader.readAsDataURL(input.files[0]);
        }
        
        // é¡¯ç¤ºè£å‰ª
        function showCropDialog(imgData) {
            document.getElementById('cropImage').src = imgData;
            document.getElementById('previewImage').classList.remove('show');
            document.getElementById('uploadBox').style.display = 'none';
            document.getElementById('cropArea').classList.add('show');
            
            setTimeout(() => {
                cropState = { x: 0.1, y: 0.1, w: 0.8, h: 0.8 };
                updateCrop();
                setupCrop();
            }, 100);
        }
        
        // è¨­å®šè£å‰ª
        function setupCrop() {
            const overlay = document.getElementById('cropOverlay');
            const container = document.getElementById('cropArea');
            let dragging = false, resizing = false;
            let startX, startY, startCrop;
            
            overlay.addEventListener('mousedown', e => {
                if (e.target === overlay) { dragging = true; startX = e.clientX; startY = e.clientY; startCrop = {...cropState}; }
                e.preventDefault();
            });
            
            document.addEventListener('mousemove', e => {
                if (!dragging && !resizing) return;
                const rect = container.getBoundingClientRect();
                const dx = (e.clientX - startX) / rect.width;
                const dy = (e.clientY - startY) / rect.height;
                
                if (dragging) {
                    cropState.x = Math.max(0, Math.min(1 - cropState.w, startCrop.x + dx));
                    cropState.y = Math.max(0, Math.min(1 - cropState.h, startCrop.y + dy));
                }
                updateCrop();
            });
            
            document.addEventListener('mouseup', () => { dragging = false; });
        }
        
        function updateCrop() {
            const overlay = document.getElementById('cropOverlay');
            overlay.style.left = (cropState.x * 100) + '%';
            overlay.style.top = (cropState.y * 100) + '%';
            overlay.style.width = (cropState.w * 100) + '%';
            overlay.style.height = (cropState.h * 100) + '%';
        }
        
        // è·³éè£å‰ª
        function skipCrop() {
            const img = document.getElementById('cropImage');
            cropImage(img, 0, 0, img.naturalWidth, img.naturalHeight);
        }
        
        // è£å‰ªåœ–ç‰‡
        function cropImage(img, srcX, srcY, srcW, srcH) {
            const canvas = document.createElement('canvas');
            const ctx = canvas.getContext('2d');
            const size = 400;
            canvas.width = size;
            canvas.height = size;
            ctx.drawImage(img, srcX, srcY, srcW, srcH, 0, 0, size, size);
            
            canvas.toBlob(blob => {
                const reader = new FileReader();
                reader.onload = e => {
                    document.getElementById('previewImage').src = e.target.result;
                    document.getElementById('previewImage').classList.add('show');
                    document.getElementById('cropArea').classList.remove('show');
                    document.getElementById('finalImage').value = e.target.result;
                };
                reader.readAsDataURL(blob);
            }, 'image/jpeg', 0.85);
        }
        
        // ç¢ºèªè£å‰ª
        function applyCrop() {
            const img = document.getElementById('cropImage');
            const srcX = cropState.x * img.naturalWidth;
            const srcY = cropState.y * img.naturalHeight;
            const srcW = cropState.w * img.naturalWidth;
            const srcH = cropState.h * img.naturalHeight;
            cropImage(img, srcX, srcY, srcW, srcH);
        }
        
        // å„²å­˜å•†å“
        function saveProduct(e) {
            e.preventDefault();
            
            const products = loadProducts();
            const id = document.getElementById('productId').value;
            
            const product = {
                id: id ? parseInt(id) : Date.now(),
                name: document.getElementById('productName').value,
                price: parseInt(document.getElementById('productPrice').value),
                stock: parseInt(document.getElementById('productStock').value),
                category: document.getElementById('productCategory').value,
                description: document.getElementById('productDesc').value,
                updated_at: new Date().toISOString()
            };
            
            // è™•ç†åœ–ç‰‡
            const finalImage = document.getElementById('finalImage').value;
            const oldImage = products.find(p => p.id == id)?.image;
            
            if (finalImage) {
                product.image = finalImage;
            } else if (oldImage) {
                product.image = oldImage;
            }
            
            if (id) {
                const idx = products.findIndex(p => p.id == id);
                if (idx !== -1) products[idx] = product;
            } else {
                product.image = product.image || 'images/products/default-guppy.svg';
                products.push(product);
            }
            
            saveProducts(products);
            closeModal();
            renderProducts();
            alert(id ? 'âœ… å·²æ›´æ–°ï¼' : 'âœ… å·²æ–°å¢ï¼');
        }
        
        // æ¸…é™¤å…¨éƒ¨
        function clearAllData() {
            if (!confirm('ç¢ºå®šæ¸…é™¤æ‰€æœ‰å•†å“ï¼Ÿ')) return;
            localStorage.removeItem(STORAGE_KEY);
            renderProducts();
        }
        
        // åˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', renderProducts);
        
        // é»æ“Šé®ç½©é—œé–‰
        document.getElementById('productModal').addEventListener('click', function(e) {
            if (e.target === this) closeModal();
        });
    </script>
</body>
</html>
